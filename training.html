<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TensorFlow.js Training Example</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
</head>
<body>
    <h1>Training TensorFlow.js Model</h1>

    <script>
        // List of categories for multi-label classification
        const categories = [
            'category_1', 'category_2', 'category_3', 'category_4', 'category_5', 
            'category_6', 'category_7', 'category_8', 'category_9', 'category_10'
        ];

        // Example: Random generated image data (simulating image data)
        const numSamples = 10;
        const height = 64;
        const width = 64;
        const channels = 3;

        // Simulating random image data (10 samples, 64x64 RGB images)
        const imageData = new Array(numSamples * height * width * channels).fill(0).map(() => Math.random());

        // Example multi-hot encoded labels for each of the 10 samples
        const labels = [
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0], // Sample 1: category_1
            [0, 1, 0, 0, 0, 0, 0, 0, 0, 0], // Sample 2: category_2
            [0, 0, 1, 0, 1, 0, 0, 0, 0, 0], // Sample 3: category_3 and category_5
            [0, 0, 0, 1, 1, 1, 0, 1, 0, 0], // Sample 4: category_4, 5, 7
            [0, 0, 0, 0, 1, 0, 0, 0, 0, 0], // Sample 5: category_5
            [0, 0, 0, 0, 0, 1, 0, 1, 0, 0], // Sample 6: category_6 and category_8
            [0, 0, 0, 0, 0, 0, 1, 1, 0, 0], // Sample 7: category_7 and category_9
            [0, 0, 0, 0, 0, 0, 0, 1, 0, 0], // Sample 8: category_8
            [0, 0, 0, 0, 1, 0, 0, 0, 1, 0], // Sample 9: category_5 and category_9
            [0, 1, 0, 0, 0, 0, 0, 0, 0, 1]  // Sample 10: category_2 and category_10
        ];

        // Create image tensor (4D tensor) [num_samples, height, width, channels]
        const imageTensor = tf.tensor4d(imageData, [numSamples, height, width, channels]);

        // Create label tensor (2D tensor) [num_samples, num_categories]
        const labelTensor = tf.tensor2d(labels);

        // Define the model
        const model = tf.sequential();
        
        // Add layers to the model
        model.add(tf.layers.conv2d({
            filters: 32,
            kernelSize: 3,
            activation: 'relu',
            inputShape: [height, width, channels]
        }));
        model.add(tf.layers.maxPooling2d({ poolSize: [2, 2] }));
        model.add(tf.layers.flatten());
        model.add(tf.layers.dense({ units: 128, activation: 'relu' }));
        model.add(tf.layers.dense({ units: categories.length, activation: 'sigmoid' })); // Sigmoid for multi-label classification

        // Compile the model
        model.compile({
            optimizer: 'adam',
            loss: 'binaryCrossentropy', // Loss for multi-label classification
            metrics: ['accuracy']
        });

        // Choose a backend (WebGL is default, fall back to CPU or WASM)
        async function setBackend() {
            await tf.setBackend('webgl'); // You can try 'cpu' or 'wasm' if needed
            console.log("Backend set to WebGL.");
        }

        // Train the model
        async function trainModel() {
            await setBackend(); // Ensure WebGL or the selected backend is set
            await model.fit(imageTensor, labelTensor, {
                epochs: 10,
                batchSize: 2,
                validationSplit: 0.2,
                callbacks: tf.callbacks.earlyStopping({ patience: 3 })
            });
            console.log("Model training completed!");
        }

        // Start training
        trainModel();

        // Function to predict with the model
        async function makePrediction(imageData) {
            const prediction = model.predict(imageData);  // Predict using new image data
            prediction.print();  // Display the predictions
        }

        // Example: Predicting with random new data
        const randomNewImageData = new Array(height * width * channels).fill(0).map(() => Math.random());
        const newImageTensor = tf.tensor4d([randomNewImageData], [1, height, width, channels]);  // New single image input
        makePrediction(newImageTensor);
    </script>
</body>
</html>
