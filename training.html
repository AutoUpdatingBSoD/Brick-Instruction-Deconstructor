<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TensorFlow.js Training</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-wasm"></script>
</head>
<body>
    <h1>TensorFlow.js Training</h1>
    <div id="output"></div>
    <button id="downloadModelButton" style="display:none;">Download Model</button>
    
    <script>
        const categories = [
            'bagset',        // category 0
            'dontreadrepeat',// category 1
            'finish',        // category 2
            'index',         // category 3
            'pageno',        // category 4
            'part',          // category 5
            'partstep',      // category 6
            'repeat',        // category 7
            'splitdecision', // category 8
            'subbuild'       // category 9
        ];

        // Example of how you'd set the labelVector for each item (adjust this based on your actual data)
        function getLabelVector(item) {
            var labelVector = new Array(categories.length).fill(0);  // Start with a vector of all 0s


// Just mark each category that applies directly:
if (item.label == 0) {
    labelVector = [1, 0, 0, 0, 0, 0, 0, 0, 0, 0];
}
if (item.label == 1) {
    labelVector = [0, 1, 0, 0, 0, 0, 0, 0, 0, 0];
}
if (item.label == 2) {
    labelVector = [0, 0, 1, 0, 1, 0, 0, 0, 0, 0]; // Multi-label case (index is also relevant)
}
if (item.label == 3) {
    labelVector = [0, 0, 0, 1, 1, 1, 0, 1, 0, 0]; // Multi-label case (index, partstep, repeat)
}
if (item.label == 4) {
    labelVector = [0, 0, 0, 0, 1, 0, 0, 0, 0, 0];
}
if (item.label == 5) {
    labelVector = [0, 0, 0, 0, 0, 1, 0, 1, 0, 0];
}
if (item.label == 6) {
    labelVector = [0, 0, 0, 0, 0, 0, 1, 1, 0, 0];
}
if (item.label == 7) {
    labelVector = [0, 0, 0, 0, 0, 0, 0, 1, 0, 0];
}
if (item.label == 8) {
    labelVector = [0, 0, 0, 0, 1, 0, 0, 0, 1, 0];
}
if (item.label == 9) {
    labelVector = [0, 1, 0, 0, 0, 0, 0, 0, 0, 1]; 
}


            return labelVector;
        }

        async function trainModel() {
            await initializeBackend();  // Initialize the selected backend

            const model = tf.sequential();
            model.add(tf.layers.conv2d({
                filters: 32,
                kernelSize: 3,
                activation: 'relu',
                inputShape: [64, 64, 3],  // Update based on your input image size
            }));
            model.add(tf.layers.maxPooling2d({ poolSize: [2, 2] }));
            model.add(tf.layers.flatten());
            model.add(tf.layers.dense({ units: 128, activation: 'relu' }));
            model.add(tf.layers.dense({ units: categories.length, activation: 'sigmoid' }));  // Multi-label output

            model.compile({
                optimizer: tf.train.adam(),
                loss: 'binaryCrossentropy',  // Loss for multi-label classification
                metrics: ['accuracy'],
            });

            const data = await fetchTrainingData();
            const xs = tf.tensor4d(data.images);  // Make sure images are preprocessed to tensors
            const ys = tf.tensor2d(data.labels);  // The labels should be in the form of label vectors

            await model.fit(xs, ys, {
                epochs: 20,
                batchSize: 16,
                validationSplit: 0.2,
                callbacks: tf.callbacks.earlyStopping({ patience: 3 }),
            });

            console.log('Model training complete');
            document.getElementById('output').innerText = 'Training complete!';
            document.getElementById('downloadModelButton').style.display = 'block';  // Show the download button
            modelJson = await model.toJSON();
        }

        async function initializeBackend() {
            // Try using WebGL, fallback to WASM if WebGL is unavailable
            try {
                await tf.setBackend('webgl');
                await tf.ready();
                console.log('WebGL backend initialized');
            } catch (error) {
                console.error('WebGL initialization failed, falling back to WASM');
                await tf.setBackend('wasm');
                await tf.ready();
                console.log('WASM backend initialized');
            }
        }

        async function fetchTrainingData() {
            // Fetch or prepare your training data
            // Example data format:
            // { images: [...], labels: [...] }
            // In your case, you'd need to load your images and associate labels as the labelVector

            const images = [];  // This should be your image data
            const labels = [];  // This should be the corresponding labels in the form of the labelVector

            // Example:
            const item = { label: 3 };  // Example item with label 3 (index)
            const labelVector = getLabelVector(item);
            labels.push(labelVector);

            // Push image tensor here (make sure your images are properly formatted as tensors)
            // images.push(preprocessedImageTensor);

            return { images, labels };
        }

        // Function to download the model as a JSON file
        document.getElementById('downloadModelButton').addEventListener('click', function() {
            const jsonBlob = new Blob([JSON.stringify(modelJson)], { type: 'application/json' });
            const url = URL.createObjectURL(jsonBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'lego-classifier-model.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        trainModel().catch(console.error);
    </script>
</body>
</html>
