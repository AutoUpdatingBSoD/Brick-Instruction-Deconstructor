<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LEGO Multi-Label Classifier Training</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.13.0"></script>
</head>
<body>
<h2>Training LEGO Classifier</h2>
<input type="file" id="imageInput" webkitdirectory directory multiple accept="image/*">
<button onclick="startTraining()">Start Training</button>

<script>
let model;
const categories = [
    'bagset', 'dontreadrepeat', 'finish', 'index', 'pageno',
    'part', 'partstep', 'repeat', 'splitdecision', 'subbuild'
];
const indices = [5, 2, 2, 4, 4, 26, 18, 4, 2, 6];

async function startTraining() {
    await tf.setBackend('webgl').catch(async () => {
        await tf.setBackend('wasm').catch(async () => {
            await tf.setBackend('cpu');
        });
    });
    await tf.ready();

    const imageInput = document.getElementById('imageInput');
    const imageFiles = Array.from(imageInput.files);

    const imageTensors = [];
    const labelTensors = [];
    for (const file of imageFiles) {
        const img = new Image();
        const reader = new FileReader();
        const loadPromise = new Promise((resolve) => {
            reader.onload = () => {
                img.onload = async () => {
                    const tensor = tf.browser.fromPixels(img).resizeNearestNeighbor([64, 64]).toFloat().div(255).expandDims();
                    imageTensors.push(tensor);

                    const label = getLabelFromFilename(file.name);
                    labelTensors.push(tf.tensor2d([label], [1, categories.length]));

                    resolve();
                };
                img.src = reader.result;
            };
            reader.readAsDataURL(file);
        });
        await loadPromise;
    }

    const xs = tf.concat(imageTensors);
    const ys = tf.concat(labelTensors);

    model = tf.sequential();
    model.add(tf.layers.conv2d({ inputShape: [64, 64, 3], filters: 32, kernelSize: 3, activation: 'relu' }));
    model.add(tf.layers.maxPooling2d({ poolSize: 2 }));
    model.add(tf.layers.conv2d({ filters: 64, kernelSize: 3, activation: 'relu' }));
    model.add(tf.layers.maxPooling2d({ poolSize: 2 }));
    model.add(tf.layers.flatten());
    model.add(tf.layers.dense({ units: 128, activation: 'relu' }));
    model.add(tf.layers.dense({ units: categories.length, activation: 'sigmoid' }));

    model.compile({ optimizer: 'adam', loss: 'binaryCrossentropy', metrics: ['accuracy'] });

    await model.fit(xs, ys, {
        epochs: 20,
        batchSize: 16,
        validationSplit: 0.2,
        callbacks: tf.callbacks.earlyStopping({ patience: 3 })
    });

    await model.save('downloads://lego-classifier');
}

function getLabelFromFilename(filename) {
    const label = parseInt(filename.split('_')[0]);
    const vector = new Array(categories.length).fill(0);

    if (label === 0) vector[0] = 1;
    if (label === 1) vector[1] = 1;
    if (label === 2) { vector[2] = 1; vector[4] = 1; }
    if (label === 3) { vector[3] = 1; vector[4] = 1; vector[5] = 1; vector[7] = 1; }
    if (label === 4) vector[4] = 1;
    if (label === 5) { vector[5] = 1; vector[7] = 1; }
    if (label === 6) { vector[6] = 1; vector[7] = 1; }
    if (label === 7) vector[7] = 1;
    if (label === 8) { vector[4] = 1; vector[8] = 1; }
    if (label === 9) { vector[1] = 1; vector[9] = 1; }

    return vector;
}
</script>
</body>
</html>
