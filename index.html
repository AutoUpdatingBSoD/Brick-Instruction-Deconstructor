<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LEGO Classifier - Testing</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h2>LEGO Instruction Classifier - Testing</h2>
    <input type="file" id="pdfInput">
    <div id="results"></div>

    <script>
    const categories = ['bagset', 'dontreadrepeat', 'finish', 'index', 'pageno', 'part', 'partstep', 'repeat', 'splitdecision', 'subbuild'];
    let model;

    async function setupModel() {
        await tf.setBackend('webgl');
        await tf.ready();
        model = await tf.loadLayersModel('model/lego-classifier.json');
        console.log('Model loaded and backend initialized');
    }

    async function processImage(img) {
        return tf.tidy(() => {
            return tf.browser.fromPixels(img)
                .resizeNearestNeighbor([64, 64])
                .toFloat()
                .div(255)
                .expandDims();
        });
    }

    async function classifyImage(img, pageIndex) {
        const tensor = await processImage(img);
        const prediction = model.predict(tensor);
        const data = await prediction.data();
        const threshold = 0.5;
        const result = [];

        data.forEach((val, i) => {
            if (val > threshold) {
                result.push({ category: categories[i], confidence: val.toFixed(2) });
            }
        });

        tf.dispose([tensor, prediction]);

        return { page: pageIndex, results: result };
    }

    async function extractImagesFromPDF(file) {
        const fileURL = URL.createObjectURL(file);
        const pdf = await pdfjsLib.getDocument(fileURL).promise;
        const allResults = [];

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            await page.render({ canvasContext: ctx, viewport }).promise;
            const image = new Image();
            image.src = canvas.toDataURL("image/jpeg");

            await new Promise(res => image.onload = res);
            const result = await classifyImage(image, i);
            allResults.push(result);
        }

        return allResults;
    }

    function displayResults(results) {
        const container = document.getElementById("results");
        container.innerHTML = "<h3>Classification Results:</h3>";

        results.forEach(pageResult => {
            const div = document.createElement("div");
            div.innerHTML = `<strong>Page ${pageResult.page}:</strong><br>`;
            if (pageResult.results.length === 0) {
                div.innerHTML += "No categories detected.<br><br>";
            } else {
                pageResult.results.forEach(res => {
                    div.innerHTML += `- ${res.category} (confidence: ${res.confidence})<br>`;
                });
                div.innerHTML += "<br>";
            }
            container.appendChild(div);
        });
    }

    $(document).ready(() => {
        setupModel();

        $("#pdfInput").on("change", async (event) => {
            const file = event.target.files[0];
            if (!file || !model) return;

            const results = await extractImagesFromPDF(file);
            displayResults(results);
        });
    });
    </script>
</body>
</html>
