<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LEGO Classifier - Testing</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #f5f5f5;
    }
    input[type="file"] {
      margin-bottom: 1em;
    }
    #preview {
      max-width: 256px;
      margin-bottom: 1em;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>LEGO Classifier - Testing</h1>
  <input type="file" id="imageInput" accept="image/*"><br>
  <img id="preview" src="" alt="Image preview"><br>
  <div id="result">Prediction: N/A</div>

  <script>
    let model;
    const categories = [
      'bagset', 'dontreadrepeat', 'finish', 'index', 'pageno',
      'part', 'partstep', 'repeat', 'splitdecision', 'subbuild'
    ];

    async function loadModel() {
      try {
        model = await tf.loadLayersModel('model/lego-classifier.json');
        console.log("✅ Model loaded.");
      } catch (e) {
        console.error("❌ Failed to load model:", e);
      }
    }

    async function classifyImage(img) {
      if (!model) {
        console.error("Model not loaded.");
        return;
      }

      const tensor = tf.tidy(() => {
        return tf.browser.fromPixels(img)
          .resizeNearestNeighbor([64, 64])
          .toFloat()
          .div(255)
          .expandDims();
      });

      const prediction = model.predict(tensor);
      const data = await prediction.data();
      const topIndex = data.indexOf(Math.max(...data));
      const label = categories[topIndex];
      document.getElementById('result').innerText = `Prediction: ${label}`;

      tensor.dispose();
      prediction.dispose();
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const img = document.getElementById('preview');
      const reader = new FileReader();
      reader.onload = function(e) {
        img.onload = () => classifyImage(img);
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    async function main() {
      await tf.setBackend('webgl');
      await tf.ready();
      await loadModel();

      document.getElementById('imageInput').addEventListener('change', handleImageUpload);
    }

    main();
  </script>
</body>
</html>
