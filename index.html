<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LEGO Classifier - Testing</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        canvas { display: none; }
        .result { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>LEGO Classifier - Multi-Label PDF Testing</h1>
    <input type="file" id="pdf-upload" accept="application/pdf">
    <div id="results"></div>

    <script>
        const categories = [
            'bagset', 'dontreadrepeat', 'finish', 'index', 'pageno',
            'part', 'partstep', 'repeat', 'splitdecision', 'subbuild'
        ];

        const indices = [5, 2, 2, 4, 4, 26, 18, 4, 2, 6];

        let model;

        async function setupBackend() {
            try {
                await tf.setBackend('webgl');
            } catch (e) {
                try {
                    await tf.setBackend('wasm');
                } catch (e2) {
                    await tf.setBackend('cpu');
                }
            }
            await tf.ready();
        }

        async function loadModel() {
            model = await tf.loadLayersModel('model/modelfiles/model.json');
            console.log('Model loaded');
        }

        function imageDataToTensor(imageData) {
            return tf.tidy(() => {
                const { data, width, height } = imageData;
                const floatData = Float32Array.from(data).filter((_, i) => i % 4 !== 3); // Remove alpha
                const imgTensor = tf.tensor(floatData, [height, width, 3], 'float32');
                return imgTensor.div(255).resizeBilinear([64, 64]).expandDims(0);
            });
        }

        async function extractImagesFromPDF(file) {
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '';

            const loadingTask = pdfjsLib.getDocument({ url: URL.createObjectURL(file) });
            const pdf = await loadingTask.promise;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 2.0 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                await page.render({ canvasContext: ctx, viewport }).promise;
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

                const input = imageDataToTensor(imageData);
                const prediction = model.predict(input).dataSync();

                const output = document.createElement('div');
                output.classList.add('result');
                output.innerHTML = `<strong>Page ${pageNum}:</strong><br>` +
                    categories.map((label, i) => `${label}: ${(prediction[i] * 100).toFixed(2)}%`).join('<br>');
                resultsContainer.appendChild(output);
            }
        }

        document.getElementById('pdf-upload').addEventListener('change', async (e) => {
            await setupBackend();
            await loadModel();
            const file = e.target.files[0];
            if (file) await extractImagesFromPDF(file);
        });
    </script>
</body>
</html>
