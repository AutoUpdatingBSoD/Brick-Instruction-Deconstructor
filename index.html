<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multi-label LEGO PDF Tester</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    canvas { display: none; }
  </style>
</head>
<body>
  <h1>Upload PDF for LEGO Multi-Label Detection</h1>
  <input type="file" id="pdfInput" accept="application/pdf">
  <div id="output"></div>

  <script>
    const categories = ['bagset', 'dontreadrepeat', 'finished', 'index', 'part', 'partstep', 'repeat', 'splitdecision', 'subbuild', 'pageno'];

    async function setupTF() {
      try {
        await tf.setBackend('webgl');
      } catch {
        await tf.setBackend('wasm');
      }
      await tf.ready();
    }

    async function loadModel() {
      return await tf.loadLayersModel('model/modelfiles/lego-classifier.json');
    }

    function preprocessImage(imageData) {
      const tensor = tf.browser.fromPixels(imageData)
        .resizeNearestNeighbor([64, 64])
        .toFloat()
        .div(255.0)
        .expandDims(0);
      return tensor;
    }

    async function extractImagesFromPDF(file) {
      const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
      const pdf = await loadingTask.promise;
      const pages = [];

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const viewport = page.getViewport({ scale: 2.0 });

        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');

        await page.render({ canvasContext: ctx, viewport }).promise;

        pages.push(canvas);
      }

      return pages;
    }

    async function classifyPages(pages, model) {
      const outputDiv = document.getElementById("output");

      for (let i = 0; i < pages.length; i++) {
        const tensor = preprocessImage(pages[i]);
        const prediction = await model.predict(tensor).data();

        const threshold = 0.5;
        const labels = prediction.map((v, idx) => v > threshold ? categories[idx] : null).filter(v => v !== null);

        const result = document.createElement('div');
        result.innerHTML = `<strong>Page ${i + 1}</strong>: ${labels.join(', ') || 'No labels detected'}`;
        outputDiv.appendChild(result);
      }
    }

    document.getElementById("pdfInput").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      await setupTF();
      const model = await loadModel();
      const result = document.createElement('div');
      const outputDiv = document.getElementById("output");
      result.innerHTML = `Model Successfully Loaded`;
      outputDiv.appendChild(result);
      const pages = await extractImagesFromPDF(file);
      await classifyPages(pages, model);
    });
  </script>
</body>
</html>
