<!DOCTYPE html>
<html>
<head>
  <title>PDF Testing</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
</head>
<body>
  <h2>Upload PDF for Model Testing</h2>
  <input type="file" id="pdf-upload" accept="application/pdf">
  <pre id="log">Awaiting file upload...</pre>

  <script>
    const log = document.getElementById("log");

    // Dummy categories — replace with your actual arrays
    const pageCategories = ["pageno", "index"];
    const sectionCategories = ["part", "partstep", "subbuild", "splitdecision", "repeat", "dontreadrepeat", "finished", "bagset"];

    // Your existing function to preprocess the image
    async function processImage(img) {
      return tf.tidy(() => {
        const tensor = tf.browser.fromPixels(img)
          .resizeNearestNeighbor([64, 64])
          .toFloat()
          .div(255.0);
        return tensor.expandDims(0);
      });
    }

    // Example model loader — swap with your trained models if needed
    async function loadModels() {
      const pageModel = await tf.loadLayersModel('/model/page_type/page-model.json'); // adjust paths
      const sectionModel = await tf.loadLayersModel('model/section_type/section-model.json');
      return { pageModel, sectionModel };
    }

    // Utility: get canvas from a PDF page
    async function renderPageToCanvas(pdfPage) {
      const viewport = pdfPage.getViewport({ scale: 2 });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      const context = canvas.getContext('2d');
      await pdfPage.render({ canvasContext: context, viewport: viewport }).promise;
      return canvas;
    }

    document.getElementById("pdf-upload").addEventListener("change", async function (e) {
      const file = e.target.files[0];
      if (!file || file.type !== "application/pdf") {
        log.textContent = "Please upload a valid PDF.";
        return;
      }

      log.textContent = `Loading models and reading PDF...\n`;

      const { pageModel, sectionModel } = await loadModels();
      const fileURL = URL.createObjectURL(file);
      const pdf = await pdfjsLib.getDocument(fileURL).promise;

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const canvas = await renderPageToCanvas(page);
        const tensor = await processImage(canvas);

        const pagePred = await pageModel.predict(tensor).data();
        const sectionPred = await sectionModel.predict(tensor).data();

        log.textContent += `\nPage ${i} predictions:\n`;

        // Format multi-label output
        pagePred.forEach((val, idx) => {
          if (val > 0.5) log.textContent += ` - PAGE: ${pageCategories[idx]} (${val.toFixed(2)})\n`;
        });

        sectionPred.forEach((val, idx) => {
          if (val > 0.5) log.textContent += ` - SECTION: ${sectionCategories[idx]} (${val.toFixed(2)})\n`;
        });

        tf.dispose([tensor]);
      }

      log.textContent += `\nDone processing all pages.`;
    });
  </script>
</body>
</html>
