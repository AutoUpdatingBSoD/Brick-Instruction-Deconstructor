<!DOCTYPE html>
<html>
<head>
    <title>LEGO Multi-Label Classifier - Testing</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        canvas, img { max-width: 100px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Testing LEGO Classifier</h1>
    <input type="file" id="imageUpload" accept="image/*">
    <div id="predictions"></div>

    <script>
    const categories = [
        'bagset', 'dontreadrepeat', 'finish', 'index', 'pageno',
        'part', 'partstep', 'repeat', 'splitdecision', 'subbuild'
    ];

    async function loadModel() {
        await tf.setBackend('webgl').catch(async () => {
            await tf.setBackend('wasm').catch(() => tf.setBackend('cpu'));
        });
        await tf.ready();
        return await tf.loadLayersModel('model/modelfiles/lego-classifier.json');
    }

    async function predictImage(model, imgElement) {
        const tensor = tf.browser.fromPixels(imgElement)
            .resizeNearestNeighbor([64, 64])
            .toFloat()
            .div(255.0)
            .expandDims();

        const prediction = model.predict(tensor);
        const values = await prediction.data();

        const results = Array.from(values)
            .map((v, i) => ({ label: categories[i], confidence: v }))
            .filter(r => r.confidence > 0.5);

        const output = document.getElementById('predictions');
        output.innerHTML = results.length ?
            results.map(r => `<div>${r.label}: ${(r.confidence * 100).toFixed(1)}%</div>`).join('') :
            '<div>No confident predictions</div>';
    }

    document.getElementById('imageUpload').addEventListener('change', async event => {
        const model = await loadModel();
        const file = event.target.files[0];
        if (!file) return;

        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => predictImage(model, img);
    });
    </script>
</body>
</html>
